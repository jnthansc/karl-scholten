---
import BaseLayout from '../../layouts/BaseLayout.astro';
import groq from 'groq';
import { sanityClient, urlForImage } from '../../lib/sanity';

type ProjectDetail = {
  title: string;
  videoUrl?: string;
  images?: Array<{
    _key: string;
    alt?: string;
    asset?: { _id: string; url: string };
  }>;
};

const PROJECT_BY_SLUG_QUERY = groq`*[_type == "project" && slug.current == $slug][0]{
  title,
  videoUrl,
  images[]{
    _key,
    alt,
    asset->{ _id, url }
  }
}`;

export async function getStaticPaths() {
  const slugs = await sanityClient.fetch<{slug: string}[]>(
    groq`*[_type == "project" && defined(slug.current)]{ "slug": slug.current }`,
  )
  return slugs.map((s) => ({params: {slug: s.slug}}))
}

const { slug } = Astro.params as { slug: string };
const project = await sanityClient.fetch<ProjectDetail | null>(PROJECT_BY_SLUG_QUERY, { slug });

// Convert YouTube/Vimeo URLs to embed format
function getEmbedUrl(url: string | undefined): string | undefined {
  if (!url) return undefined;
  
  try {
    const urlObj = new URL(url);
    
    // YouTube: convert watch URLs or short URLs to embed format
    if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('youtu.be')) {
      let videoId: string | null = null;
      
      if (urlObj.hostname.includes('youtu.be')) {
        // Short URL format: https://youtu.be/VIDEO_ID
        videoId = urlObj.pathname.slice(1);
      } else if (urlObj.pathname === '/watch' && urlObj.searchParams.has('v')) {
        // Regular URL format: https://www.youtube.com/watch?v=VIDEO_ID
        videoId = urlObj.searchParams.get('v');
      } else if (urlObj.pathname.startsWith('/embed/')) {
        // Already an embed URL
        return url;
      }
      
      if (videoId) {
        return `https://www.youtube.com/embed/${videoId}`;
      }
    }
    
    // Vimeo: convert regular URLs to embed format
    if (urlObj.hostname.includes('vimeo.com')) {
      const videoId = urlObj.pathname.split('/').filter(Boolean).pop();
      if (videoId && !urlObj.pathname.startsWith('/video/')) {
        return `https://player.vimeo.com/video/${videoId}`;
      } else if (urlObj.hostname.includes('player.vimeo.com')) {
        // Already an embed URL
        return url;
      }
    }
    
    // Return original URL if not YouTube/Vimeo or if conversion failed
    return url;
  } catch {
    // If URL parsing fails, return original
    return url;
  }
}

const embedUrl = project?.videoUrl ? getEmbedUrl(project.videoUrl) : undefined;
const hasImages = project?.images && project.images.length > 0;
const videoOnly = embedUrl && !hasImages;
---

<BaseLayout title={`${project?.title ?? 'Project'} – Karl Scholten`} projectTitle={project?.title}>
  <div class={`project-content ${videoOnly ? 'video-only' : ''}`}>
    {project ? (
      <>
        {embedUrl ? (
          <section class="videoSection">
            <div class="videoFrame">
              <iframe
                src={embedUrl}
                title={`${project.title} video`}
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
              />
            </div>
          </section>
        ) : null}

        <section class="stack" aria-label={`Images for ${project.title}`}>
          {(project.images ?? []).map((img, i) => (
            <figure class="frame" key={img._key}>
              {img.asset ? (
                <img
                  src={urlForImage(img).width(1600).quality(80).url()}
                  alt={img.alt ?? `${project.title} – image ${i + 1}`}
                  loading={i === 0 ? 'eager' : 'lazy'}
                  decoding="async"
                />
              ) : null}
            </figure>
          ))}
        </section>
      </>
    ) : (
      <p class="muted">Project not found.</p>
    )}
  </div>
</BaseLayout>

<style>
  .project-content {
    width: 100%;
  }

  @media (max-width: 900px) {
    .project-content.video-only {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 100vh;
      padding-top: calc(var(--headerH) + 20px);
      padding-bottom: calc(var(--footerH) + 20px);
      box-sizing: border-box;
    }
  }

  @media (min-width: 901px) {
    .project-content {
      margin-left: -10px;
      margin-right: -10px;
      width: calc(100% + 20px);
    }
  }


  .stack {
    display: grid;
    gap: 0;
  }

  .videoSection {
    margin-bottom: 0;
  }

  @media (max-width: 900px) {
    .project-content.video-only .videoSection {
      margin-bottom: 0;
    }
  }

  .videoFrame {
    position: relative;
    width: 100%;
    padding-top: 56.25%; /* 16:9 */
    border-radius: 0;
    overflow: hidden;
    border: none;
    box-shadow: var(--shadow);
    background: #000;
  }

  .videoFrame > iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  .frame {
    margin: 0;
    border-radius: 0;
    overflow: hidden;
    border: none;
    background: #e9ecf2;
    box-shadow: var(--shadow);
  }

  .frame > img {
    width: 100%;
    height: auto;
    display: block;
  }
</style>


